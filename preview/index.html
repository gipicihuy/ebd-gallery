<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eberardos Preview</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.ibb.co/r2KDVBJC/IMG-20241225-WA0318.jpg" type="image/jpeg">
    <style>
        :root{--primary:#e63946;--primary-dark:#d90429;--secondary:#2b2d42;--secondary-light:#414563;--accent:#fca311;--light:#f8f9fa;--dark:#212529;--gray:#8d99ae;--success:#2a9d8f;--error:#e63946}*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins","Segoe UI",Tahoma,Geneva,Verdana,sans-serif}body{background:linear-gradient(135deg,#0c0c0c 0%,#2b2d42 100%);color:var(--light);line-height:1.6;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}#preview-container{max-width:800px;width:100%;background:rgba(43,45,66,0.9);backdrop-filter:blur(10px);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);text-align:center}h1{font-size:1.8rem;margin-bottom:10px;font-weight:700;word-wrap:break-word;color:var(--light)}#image-content{margin-top:20px}#image-content img{max-width:100%;height:auto;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.4);display:block;margin:0 auto}#metadata{margin-top:20px;text-align:left;background:var(--secondary-light);padding:20px;border-radius:12px}#metadata p{margin-bottom:8px;font-size:1rem}#metadata strong{color:var(--accent);font-weight:600}#action-buttons{margin-top:30px;display:flex;justify-content:center;gap:15px}button{background:var(--primary);color:var(--light);border:none;padding:10px 20px;border-radius:50px;font-size:1rem;cursor:pointer;transition:background .3s ease}.download-btn{background:var(--success)}p.error-message{color:var(--error);margin:20px 0;padding:15px;background:rgba(230,57,70,0.2);border:1px solid rgba(230,57,70,0.3);border-radius:8px;text-align:center}.loading{display:inline-block;width:30px;height:30px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin:20px}@keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="preview-container">
        <h1 id="title">Memuat...</h1>
        <div id="image-content">
            <div class="loading"></div>
        </div>
        <div id="metadata">
            <p><strong>URL:</strong> <span id="meta-url">Memuat...</span></p>
            <p><strong>Nama File:</strong> <span id="meta-filename">Memuat...</span></p>
            <p><strong>Diunggah:</strong> <span id="meta-date">Memuat...</span></p>
            <p><strong>Short Code:</strong> <span id="meta-code">Memuat...</span></p>
        </div>
        <div id="action-buttons">
            <button id="download-btn" class="download-btn" disabled><i class="fas fa-download"></i> Unduh File</button>
            <button onclick="window.location.href='/'"><i class="fas fa-arrow-left"></i> Kembali ke Galeri</button>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const REPO_OWNER = 'gipicihuy'; 
        const REPO_NAME = 'ebd-gallery';
        const REPO_BRANCH = 'main'; 

        // URL Sumber Data Ganda
        const JSON_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/result-quax.json`; 
        const INDEX_JSON_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/gallery-index.json`; 
        // -------------------

        const titleElement = document.getElementById('title');
        const imageContent = document.getElementById('image-content');
        const metaUrl = document.getElementById('meta-url');
        const metaFilename = document.getElementById('meta-filename');
        const metaDate = document.getElementById('meta-date');
        const metaCode = document.getElementById('meta-code');
        const downloadBtn = document.getElementById('download-btn');

        let allGalleryData = [];

        function showError(message) {
            titleElement.textContent = "Error: Gambar Tidak Ditemukan";
            imageContent.innerHTML = `<p class="error-message"><i class="fas fa-exclamation-circle"></i> ${message}</p>`;
            metaUrl.textContent = metaFilename.textContent = metaDate.textContent = metaCode.textContent = "N/A";
            downloadBtn.disabled = true;
        }

        function setMetaTags(image) {
            document.title = `${image.original_name} - Eberardos Preview`;
            
            // Set OG Tags untuk sharing
            const tags = [
                { property: "og:title", content: `${image.original_name} - Eberardos Gallery` },
                { property: "og:description", content: "Lihat gambar ini di Eberardos Gallery" },
                { property: "og:image", content: image.download_url },
                { property: "og:url", content: window.location.href },
            ];
            tags.forEach(tag => {
                let meta = document.querySelector(`meta[property="${tag.property}"]`);
                if (!meta) {
                    meta = document.createElement("meta");
                    meta.setAttribute("property", tag.property);
                    document.head.appendChild(meta);
                }
                meta.setAttribute("content", tag.content);
            });
        }

        function renderImage(image) {
            const displayDate = new Date(image.uploaded_at).toLocaleDateString("id-ID", { 
                day: "numeric", month: "long", year: "numeric", hour: '2-digit', minute: '2-digit' 
            });

            titleElement.textContent = image.original_name;
            imageContent.innerHTML = `<img src="${image.download_url}" alt="${image.original_name}">`;
            
            metaUrl.innerHTML = `<a href="${image.download_url}" target="_blank">Lihat Langsung</a>`;
            metaFilename.textContent = image.name || 'N/A';
            metaDate.textContent = displayDate;
            metaCode.textContent = image.id;
            
            downloadBtn.disabled = false;
            downloadBtn.onclick = () => {
                // Membuat tautan unduhan
                const link = document.createElement('a');
                link.href = image.download_url;
                link.download = image.original_name || 'download';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            setMetaTags(image);
        }

        async function fetchAllData() {
            try {
                const [indexResponse, jsonResponse] = await Promise.all([
                    fetch(INDEX_JSON_URL), 
                    fetch(JSON_URL)       
                ]);
                
                let newUploads = [];
                if (indexResponse.ok) {
                     try {
                        newUploads = await indexResponse.json();
                        newUploads = newUploads.map(item => ({
                            ...item, 
                            source: 'github_upload', 
                            id: (item.id || item.short_code || Date.now()).toString(), 
                            download_url: item.download_url || item.url 
                        })).filter(item => item.download_url);
                    } catch (e) {
                        console.warn("JSON Index baru (gallery-index.json) invalid. Mengabaikan.");
                    }
                }
                
                let oldQuaxData = [];
                if (jsonResponse.ok) {
                    try {
                        oldQuaxData = await jsonResponse.json();
                    } catch (e) {
                        console.warn("JSON lama (result-quax.json) invalid. Mengabaikan.");
                    }
                }
                
                const oldData = oldQuaxData
                    .filter(item => item.quax_url && (item.id || item.short_code)) 
                    .map(item => ({
                        id: (item.id || item.short_code).toString(),
                        name: `quax_${(item.id || item.short_code)}`, 
                        download_url: item.quax_url, 
                        original_name: item.original_name || 'Qu.ax Upload',
                        uploaded_at: item.uploaded_at || new Date(parseInt(item.id || item.short_code)).toISOString(),
                        source: 'quax_json'
                    }));

                // Gabungkan kedua sumber data
                allGalleryData = [...newUploads, ...oldData]; 
                return true;

            } catch(e) {
                console.error("Error fetching all data:", e);
                showError("Gagal memuat data galeri dari GitHub. Cek koneksi Anda.");
                return false;
            }
        }

        async function loadData() {
            // 1. Ambil ID dari URL (contoh: /preview/1716752000)
            const pathSegments = window.location.pathname.split('/').filter(segment => segment.length > 0);
            const imageCode = pathSegments[pathSegments.length - 1];

            if (!imageCode || imageCode === 'preview') {
                showError("Format tautan pratinjau tidak valid.");
                return;
            }

            // 2. Fetch semua data
            const success = await fetchAllData();
            if (!success) return;

            // 3. Cari gambar berdasarkan ID
            const image = allGalleryData.find(item => item.id === imageCode);

            if (image) {
                renderImage(image);
            } else {
                showError(`Gambar dengan ID/Kode **${imageCode}** tidak ditemukan dalam indeks galeri.`);
            }
        }

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
