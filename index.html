<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eberardos Uploader & Gallery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.ibb.co/r2KDVBJC/IMG-20241225-WA0318.jpg" type="image/jpeg">
    <style>
        :root{--primary:#e63946;--primary-dark:#d90429;--secondary:#2b2d42;--secondary-light:#414563;--accent:#fca311;--light:#f8f9fa;--dark:#212529;--gray:#8d99ae;--success:#2a9d8f;--error:#e63946}*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins","Segoe UI",Tahoma,Geneva,Verdana,sans-serif}body{background:linear-gradient(135deg,#0c0c0c 0%,#2b2d42 100%);color:var(--light);line-height:1.6;min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}#main-container{max-width:1000px;width:100%;background:rgba(43,45,66,0.9);backdrop-filter:blur(10px);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);text-align:center;margin-bottom:20px}h1{font-size:2.5rem;margin-bottom:30px;font-weight:800;background:linear-gradient(90deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 10px rgba(230,57,70,0.3)}.upload-section{margin-bottom:30px;padding:20px;border:2px dashed var(--gray);border-radius:12px;background:var(--secondary-light)}.file-upload-box{display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background .3s ease}.file-upload-box input[type=file]{display:none}.file-upload-box p{margin:10px 0;font-size:1.1rem;color:var(--gray)}.file-icon{font-size:3rem;color:var(--primary)}.custom-file-input-wrapper{margin-bottom:15px}.custom-file-input{display:inline-block;padding:10px 15px;background:var(--primary);color:var(--light);border-radius:8px;cursor:pointer;transition:background .3s ease}.custom-file-input:hover{background:var(--primary-dark)}.custom-name-container{margin-top:15px}.custom-name-container input{padding:10px;border-radius:6px;border:1px solid var(--gray);background:var(--secondary-light);color:var(--light);width:100%;max-width:300px;transition:border-color .3s ease}.custom-name-container input:focus{border-color:var(--accent);outline:none}.upload-btn{background:var(--success);color:var(--light);border:none;padding:12px 30px;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:background .3s ease,transform .1s ease}.upload-btn:hover:not(:disabled){background:#24897c;transform:translateY(-1px)}.upload-btn:disabled{background:var(--gray);cursor:not-allowed}.progress-bar-container{margin-top:15px;background:var(--secondary);border-radius:10px;height:10px;overflow:hidden}.progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--primary));transition:width .4s ease-in-out}.status-message{margin-top:15px;font-size:1rem;font-weight:500}.status-message.success{color:var(--success)}.status-message.error{color:var(--error)}.status-message.uploading{color:var(--accent)}.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px}.gallery-item{background:var(--secondary-light);border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.4);transition:transform .3s ease,box-shadow .3s ease;opacity:1}.gallery-item:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.5)}.item-link{text-decoration:none;display:block;color:var(--light)}.item-image-wrapper{height:200px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000}.item-image{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}.gallery-item:hover .item-image{transform:scale(1.05)}.item-info{padding:15px;text-align:left}.item-name{font-size:1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--light)}.item-date{font-size:.8rem;color:var(--gray);margin-top:5px}.loading{display:inline-block;width:30px;height:30px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin:20px}@keyframes spin{to{transform:rotate(360deg)}}.error-message{color:var(--error);margin:20px 0;padding:15px;background:rgba(230,57,70,0.2);border:1px solid rgba(230,57,70,0.3);border-radius:8px;text-align:center}footer{text-align:center;padding:20px;margin-top:40px;color:var(--gray)}@media (max-width:768px){#main-container{padding:20px}h1{font-size:2rem}.gallery-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    </style>
</head>
<body>
    <div id="main-container">
        <h1>Eberardos Uploader & Gallery</h1>

        <div class="upload-section">
            <div id="file-upload-box" class="file-upload-box">
                <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif" />
                <i class="file-icon fas fa-cloud-upload-alt"></i>
                <p id="file-status">Klik atau seret file untuk mengunggah.</p>
                <div class="custom-file-input-wrapper">
                    <label for="file-input" class="custom-file-input">Pilih File</label>
                </div>
            </div>
            
            <div id="custom-name-container" class="custom-name-container" style="display: none;">
                <input type="text" id="custom-name-input" placeholder="Masukkan nama file (opsional)">
            </div>
            
            <p style="color: var(--gray); font-size: 0.85rem; margin-top: 15px;">Mendukung: JPG, PNG, GIF (Maks. 4.5MB)</p>

            <button id="upload-btn" class="upload-btn" disabled>
                <i class="fas fa-upload"></i> Unggah Sekarang
            </button>

            <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            
            <div id="status-message" class="status-message"></div>
        </div>
        
        <h2 style="font-size: 1.8rem; margin: 40px 0 20px 0; color: var(--light);">Galeri Gambar</h2>
        
        <div id="gallery-grid" class="gallery-grid">
            <div class="loading"></div>
            <p>Memuat galeri...</p>
        </div>
    </div>
    
    <footer>
        <p>Eberardos Uploader &copy; 2025</p>
    </footer>

    <script>
        // =======================================================
        // KONFIGURASI 
        // =======================================================
        const API_UPLOAD_ENDPOINT = '/api/upload-github'; 
        const MAX_FILE_SIZE = 4.5 * 1024 * 1024; // 4.5MB limit
        
        // Konfigurasi Repo
        const REPO_OWNER = 'gipicihuy'; 
        const REPO_NAME = 'ebd-gallery';
        const REPO_BRANCH = 'main'; 

        // URL Sumber Data Ganda
        const JSON_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/result-quax.json`; // Data Lama (Qu.ax)
        // URL untuk metadata upload GitHub (Data Baru)
        const INDEX_JSON_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/gallery-index.json`; 

        // =======================================================

        const fileInput = document.getElementById("file-input");
        const uploadBtn = document.getElementById("upload-btn");
        const progressBar = document.getElementById("progress-bar");
        const statusMessage = document.getElementById("status-message");
        const fileStatus = document.getElementById("file-status");
        const customNameInput = document.getElementById("custom-name-input");
        const customNameContainer = document.getElementById("custom-name-container");
        const galleryGrid = document.getElementById("gallery-grid");
        
        let galleryData = []; 
        let selectedFile = null;

        // ... (Fungsi Utility dan Upload File Dihilangkan untuk mempersingkat tampilan, tidak ada perubahan) ...
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function resetForm() {
            fileStatus.innerHTML = `Klik atau seret file untuk mengunggah.`;
            fileInput.value = "";
            selectedFile = null;
            customNameInput.value = "";
            customNameContainer.style.display = "none";
            uploadBtn.disabled = true;
            progressBar.style.width = "0%";
            progressBar.parentNode.style.display = "none";
            statusMessage.textContent = "";
            statusMessage.className = "status-message";
        }

        function showStatus(message, type) {
            statusMessage.innerHTML = message;
            statusMessage.className = "status-message";
            if (type) statusMessage.classList.add(type);
        }

        function handleFileSelection(file) {
            if (!file) return;

            if (file.size > MAX_FILE_SIZE) {
                showStatus(`Ukuran file melebihi batas ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(2)}MB.`, "error");
                selectedFile = null;
                uploadBtn.disabled = true;
                return;
            }

            selectedFile = file;
            fileStatus.innerHTML = `File terpilih: <strong>${file.name}</strong> (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
            customNameContainer.style.display = "block";
            uploadBtn.disabled = false;
            showStatus("Siap diunggah.", "success");
        }
        
        function addNewItemToGallery(image) {
            galleryData.unshift(image); 
            renderGallery();
        }

        async function uploadFile() {
            if (!selectedFile) {
                showStatus("Pilih file terlebih dahulu.", "error");
                return;
            }

            uploadBtn.disabled = true;
            progressBar.parentNode.style.display = "block";
            progressBar.style.width = "10%";
            showStatus("Memulai upload...", "uploading");

            try {
                const base64File = await readFileAsBase64(selectedFile);

                progressBar.style.width = "40%";
                showStatus("Mengunggah dan menyimpan permanen ke GitHub...", "uploading");

                const apiResponse = await fetch(API_UPLOAD_ENDPOINT, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        file: base64File,
                        custom_name: customNameInput.value.trim() 
                    }) 
                });
                
                let apiResult;
                const clonedResponse = apiResponse.clone();
                
                try {
                    apiResult = await apiResponse.json();
                } catch (e) {
                    const responseText = await clonedResponse.text();
                    console.error("Respon Non-JSON/Error diterima:", responseText);
                    throw new Error(`API mengembalikan respons non-JSON/invalid: ${responseText.substring(0, 50)}...`);
                }

                if (apiResult.success && apiResult.url) {
                    const githubUrl = apiResult.url;
                    
                    const newImageEntry = apiResult;

                    progressBar.style.width = "100%";
                    showStatus(`Upload ke GitHub **BERHASIL**! Link: <a href="${githubUrl}" target="_blank">${githubUrl}</a>`, "success");
                    
                    addNewItemToGallery(newImageEntry);
                    
                    resetForm();

                } else {
                    throw new Error(apiResult.details || 'Upload gagal - Tidak ada URL GitHub diterima.');
                }

            } catch (e) {
                console.error("Error during upload:", e);
                showStatus(`Gagal total: ${e.message}.`, "error");
                uploadBtn.disabled = false;
                progressBar.style.width = "0%";
            }
        }
        // =======================================================
        // LOAD & RENDER GALLERY
        // =======================================================
        
        function renderGallery() {
             if (galleryData.length === 0) {
                galleryGrid.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:var(--gray)">Belum ada gambar yang diupload</p>';
                return;
            }

            galleryData.sort((a, b) => b.id.localeCompare(a.id)); 

            galleryGrid.innerHTML = galleryData.map(image => {
                const displayUrl = image.download_url || image.url; 
                
                const originalName = image.original_name || (image.name ? image.name.replace(/\.[^/.]+$/, "") : 'Gambar'); 
                const code = image.id; 
                
                const displayDate = image.uploaded_at 
                    ? new Date(image.uploaded_at).toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric", hour: '2-digit', minute: '2-digit' }) 
                    : 'Tanggal Tidak Tersedia';

                if (!displayUrl || !code) return '';

                return `
                    <div class="gallery-item" data-shortcode="${code}">
                        <a href="/preview/${code}" class="item-link"> 
                            <div class="item-image-wrapper">
                                <img src="${displayUrl}" alt="${originalName}" loading="lazy" class="item-image">
                            </div>
                            <div class="item-info">
                                <div class="item-name">${originalName}</div>
                                <div class="item-date">Diunggah: ${displayDate}</div>
                            </div>
                        </a>
                    </div>
                `;
            }).join('');
        }

        async function loadGallery(){
            galleryGrid.innerHTML = `<div class="loading"></div><p>Memuat galeri dari JSON lama dan JSON indeks baru...</p>`;
            try {
                // Lakukan dua fetch secara paralel
                const [indexResponse, jsonResponse] = await Promise.all([
                    fetch(INDEX_JSON_URL), // Data Baru: gallery-index.json
                    fetch(JSON_URL)       // Data Lama: result-quax.json
                ]);
                
                // 1. Ambil Data Baru (gallery-index.json)
                let newUploads = [];
                if (indexResponse.ok) {
                     try {
                        newUploads = await indexResponse.json();
                        newUploads = newUploads
                            .map(item => ({
                                ...item, 
                                source: 'github_upload', 
                                id: (item.id || item.short_code || Date.now()).toString(), 
                                download_url: item.download_url || item.url
                            }))
                            .filter(item => item.download_url);
                    } catch (e) {
                        console.warn("JSON Index baru (gallery-index.json) kosong atau invalid. Mengabaikan.", e.message);
                    }
                }
                
                // 2. Ambil Data Lama (result-quax.json)
                let oldQuaxData = [];
                if (jsonResponse.ok) {
                    try {
                        oldQuaxData = await jsonResponse.json();
                    } catch (e) {
                        console.warn("JSON lama (result-quax.json) kosong atau invalid. Mengabaikan.", e.message);
                    }
                }
                
                // 3. Normalisasi Data Lama (result-quax.json)
                const oldData = oldQuaxData
                    .filter(item => item.quax_url && (item.id || item.short_code)) 
                    .map(item => ({
                        id: (item.id || item.short_code).toString(),
                        name: `quax_${(item.id || item.short_code)}`, 
                        download_url: item.quax_url, 
                        original_name: item.original_name || 'Qu.ax Upload',
                        uploaded_at: item.uploaded_at || new Date(parseInt(item.id || item.short_code)).toISOString(),
                        source: 'quax_json'
                    }));

                // 4. Gabungkan dan Urutkan
                galleryData = [...newUploads, ...oldData]; 
                
                galleryData.sort((a, b) => b.id.localeCompare(a.id)); 

                renderGallery();

            } catch(e) {
                console.error("Error loading gallery:", e);
                galleryGrid.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>Gagal memuat galeri. ${e.message}</p></div>`;
            }
        }

        // =======================================================
        // EVENT LISTENERS
        // =======================================================

        fileInput.addEventListener("change", (e) => {
            handleFileSelection(e.target.files[0]);
        });
        
        // Drag and Drop
        const fileUploadBox = document.getElementById("file-upload-box");
        fileUploadBox.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--primary)";
        });

        fileUploadBox.addEventListener("dragleave", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--gray)";
        });

        fileUploadBox.addEventListener("drop", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--gray)";
            handleFileSelection(e.dataTransfer.files[0]);
        });

        uploadBtn.addEventListener("click", uploadFile);

        document.addEventListener("DOMContentLoaded", loadGallery);
    </script>
</body>
</html>
