<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eberardos Uploader</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.ibb.co/r2KDVBJC/IMG-20241225-WA0318.jpg" type="image/jpeg">
    <style>
        :root{--primary:#e63946;--primary-dark:#d90429;--secondary:#2b2d42;--secondary-light:#414563;--accent:#fca311;--light:#f8f9fa;--dark:#212529;--gray:#8d99ae;--success:#2a9d8f;--error:#e63946}*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins","Segoe UI",Tahoma,Geneva,Verdana,sans-serif}body{background:linear-gradient(135deg,#0c0c0c 0%,#2b2d42 100%);color:var(--light);line-height:1.6;min-height:100vh;padding:20px;display:flex;flex-direction:column;align-items:center}#main-container{max-width:1000px;width:100%;background:rgba(43,45,66,0.9);backdrop-filter:blur(10px);padding:30px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);text-align:center;margin-bottom:20px}h1{font-size:2.5rem;margin-bottom:30px;font-weight:800;background:linear-gradient(90deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 10px rgba(230,57,70,0.3)}.upload-section{margin-bottom:30px;padding:20px;border:2px dashed var(--gray);border-radius:12px;background:var(--secondary-light)}.file-upload-box{display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background .3s ease}.file-upload-box input[type=file]{display:none}.file-upload-box p{margin:10px 0;font-size:1.1rem;color:var(--gray)}.file-icon{font-size:3rem;color:var(--primary)}.custom-file-input-wrapper{margin-bottom:15px}.custom-file-input{display:inline-block;padding:10px 15px;background:var(--primary);color:var(--light);border-radius:8px;cursor:pointer;transition:background .3s ease}.custom-file-input:hover{background:var(--primary-dark)}.custom-name-container{margin-top:15px;display:none}.custom-name-container input{padding:10px;border-radius:6px;border:1px solid var(--gray);background:var(--secondary-light);color:var(--light);width:100%;max-width:300px;transition:border-color .3s ease}.custom-name-container input:focus{border-color:var(--accent);outline:none}.upload-btn{background:var(--success);color:var(--light);border:none;padding:12px 30px;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:background .3s ease,transform .1s ease}.upload-btn:hover:not(:disabled){background:#24897c;transform:translateY(-1px)}.upload-btn:disabled{background:var(--gray);cursor:not-allowed}.progress-bar-container{margin-top:15px;background:var(--secondary);border-radius:10px;height:10px;overflow:hidden}.progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--primary));transition:width .4s ease-in-out}.status-message{margin-top:15px;font-size:1rem;font-weight:500}.status-message.success{color:var(--success)}.status-message.error{color:var(--error)}.status-message.uploading{color:var(--accent)}.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px}.gallery-item{background:var(--secondary-light);border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.4);transition:transform .3s ease,box-shadow .3s ease}.gallery-item:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.5)}.item-link{text-decoration:none;display:block;color:var(--light)}.item-image-wrapper{height:200px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#000}.item-image{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}.gallery-item:hover .item-image{transform:scale(1.05)}.item-info{padding:15px;text-align:left}.item-name{font-size:1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--light)}.item-date{font-size:.8rem;color:var(--gray);margin-top:5px}.loading{display:inline-block;width:30px;height:30px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin:20px}@keyframes spin{to{transform:rotate(360deg)}}.error-message{color:var(--error);margin:20px 0;padding:15px;background:rgba(230,57,70,0.2);border:1px solid rgba(230,57,70,0.3);border-radius:8px;text-align:center}footer{text-align:center;padding:20px;margin-top:40px;color:var(--gray)}@media (max-width:768px){#main-container{padding:20px}h1{font-size:2rem}.gallery-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}}
    </style>
</head>
<body>
    <div id="main-container">
        <h1>Eberardos Uploader & Gallery</h1>

        <div class="upload-section">
            <div id="file-upload-box" class="file-upload-box">
                <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif" />
                <input type="file" id="file-input-legacy" accept="image/jpeg,image/png,image/gif" style="display: none;">
                <i class="file-icon fas fa-cloud-upload-alt"></i>
                <p id="file-status">Klik atau seret file untuk mengunggah.</p>
                <div class="custom-file-input-wrapper">
                    <label for="file-input-legacy" class="custom-file-input">Pilih File</label>
                </div>
            </div>
            
            <div id="custom-name-container" class="custom-name-container">
                <input type="text" id="custom-name-input" placeholder="Masukkan nama file (opsional)">
            </div>
            
            <p style="color: var(--gray); font-size: 0.85rem; margin-top: 15px;">Mendukung: JPG, PNG, GIF (Maks. 5MB)</p>

            <button id="upload-btn" class="upload-btn" disabled>
                <i class="fas fa-upload"></i> Unggah Sekarang
            </button>

            <div id="progress-bar-container" class="progress-bar-container" style="display: none;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            
            <div id="status-message" class="status-message"></div>
        </div>
        
        <h2 style="font-size: 1.8rem; margin: 40px 0 20px 0; color: var(--light);">Galeri Gambar</h2>
        
        <div id="gallery-grid" class="gallery-grid">
            <div class="loading"></div>
            <p>Memuat galeri...</p>
        </div>
    </div>
    
    <footer>
        <p>Eberardos Uploader &copy; 2025</p>
    </footer>

    <script>
        // =======================================================
        // KONFIGURASI QU.AX & METADATA
        // =======================================================
        const QUAX_UPLOAD_API = 'https://qu.ax/upload.php';
        const JSON_URL = 'https://raw.githubusercontent.com/gipicihuy/ebd-gallery/refs/heads/main/result-quax.json';
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

        // **PENTING: API SERVER UNTUK SIMPAN METADATA**
        // Anda HARUS MENGUBAH ini dengan endpoint API server Anda sendiri
        // yang bertugas menerima data JSON baru dan mengupdatenya di result-quax.json di GitHub.
        // Jika Anda tidak memilikinya, data baru TIDAK AKAN muncul di galeri.
        const METADATA_SAVE_API = 'https://example.com/api/save-quax-metadata'; 
        // =======================================================

        const fileInput = document.getElementById("file-input");
        const fileInputLegacy = document.getElementById("file-input-legacy");
        const uploadBtn = document.getElementById("upload-btn");
        const progressBar = document.getElementById("progress-bar");
        const statusMessage = document.getElementById("status-message");
        const fileStatus = document.getElementById("file-status");
        const customNameInput = document.getElementById("custom-name-input");
        const customNameContainer = document.getElementById("custom-name-container");
        const galleryGrid = document.getElementById("gallery-grid");

        let selectedFile = null;

        // =======================================================
        // FUNGSI UTILITY
        // =======================================================

        function generateShortCode(length = 6) {
            const characters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        function resetForm() {
            fileStatus.innerHTML = `Klik atau seret file untuk mengunggah.`;
            fileInput.value = "";
            fileInputLegacy.value = "";
            selectedFile = null;
            customNameInput.value = "";
            customNameContainer.style.display = "none";
            uploadBtn.disabled = true;
            progressBar.style.width = "0%";
            progressBar.parentNode.style.display = "none";
            statusMessage.textContent = "";
            statusMessage.className = "status-message";
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = "status-message";
            if (type) statusMessage.classList.add(type);
        }

        function handleFileSelection(file) {
            if (!file) return;

            if (file.size > MAX_FILE_SIZE) {
                showStatus(`Ukuran file melebihi batas ${MAX_FILE_SIZE / 1024 / 1024}MB.`, "error");
                selectedFile = null;
                uploadBtn.disabled = true;
                return;
            }

            selectedFile = file;
            fileStatus.innerHTML = `File terpilih: <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            customNameContainer.style.display = "block";
            uploadBtn.disabled = false;
            showStatus("Siap diunggah.", "success");
        }

        // =======================================================
        // UPLOAD FILE KE QU.AX
        // =======================================================

        async function uploadFile() {
            if (!selectedFile) {
                showStatus("Pilih file terlebih dahulu.", "error");
                return;
            }

            uploadBtn.disabled = true;
            progressBar.parentNode.style.display = "block";
            progressBar.style.width = "10%";
            showStatus("Memulai upload...", "uploading");

            try {
                // 1. Upload ke Qu.ax
                const formData = new FormData();
                formData.append('file', selectedFile, selectedFile.name);

                progressBar.style.width = "50%";
                showStatus("Mengunggah ke Qu.ax...", "uploading");

                const quaxResponse = await fetch(QUAX_UPLOAD_API, {
                    method: 'POST',
                    body: formData,
                });
                
                const quaxResult = await quaxResponse.text();
                
                // Cek jika Qu.ax berhasil (respon berupa URL)
                if (quaxResponse.ok && quaxResult.trim().startsWith('http')) {
                    const quaxUrl = quaxResult.trim();
                    const originalFileName = customNameInput.value.trim() || selectedFile.name;
                    const shortCode = generateShortCode(); // Generate unique shortcode

                    // 2. Siapkan Metadata
                    const metadata = {
                        name: `${shortCode}_${Date.now()}.${originalFileName.split('.').pop()}`, // Nama file di storage
                        original_name: originalFileName,
                        url: null, // Supabase URL (kosongkan)
                        uploaded_at: new Date().toISOString(),
                        short_code: shortCode,
                        quax_url: quaxUrl,
                        // Idx dan Id akan diatur oleh server Anda.
                    };

                    progressBar.style.width = "75%";
                    showStatus("Upload Qu.ax berhasil. Menyimpan data ke server...", "uploading");
                    
                    // 3. Kirim Metadata ke API Server Anda (Perlu Implementasi Backend)
                    // **HANYA TEMPLATE** - Pastikan Anda MENGGANTI METADATA_SAVE_API
                    const saveResponse = await fetch(METADATA_SAVE_API, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(metadata)
                    });

                    if (saveResponse.ok) {
                        progressBar.style.width = "100%";
                        showStatus(`Upload & Data Tersimpan berhasil! Link: ${quaxUrl}`, "success");
                        resetForm();
                        // Muat ulang galeri untuk menampilkan gambar baru
                        await loadGallery(); 
                    } else {
                        throw new Error(`Gagal menyimpan metadata. Status: ${saveResponse.status}`);
                    }

                } else {
                    throw new Error(`Gagal mengunggah ke Qu.ax. Respon: ${quaxResult}`);
                }

            } catch (e) {
                console.error("Error during upload:", e);
                showStatus(`Gagal total: ${e.message}. Periksa konsol.`, "error");
                uploadBtn.disabled = false;
                progressBar.style.width = "0%";
            }
        }

        // =======================================================
        // LOAD GALLERY DARI JSON
        // =======================================================

        async function loadGallery(){
            galleryGrid.innerHTML = `<div class="loading"></div><p>Memuat galeri...</p>`;
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) throw new Error("Gagal memuat data galeri dari JSON.");
                
                let allImages = await response.json();
                
                // Urutkan berdasarkan id/idx menurun (terbaru di atas)
                allImages.sort((a, b) => (b.id || b.idx) - (a.id || a.idx)); 

                if (allImages.length === 0) {
                    galleryGrid.innerHTML = '<p style="text-align:center;grid-column:1/-1;color:var(--gray)">Belum ada gambar yang diupload</p>';
                    return;
                }

                galleryGrid.innerHTML = allImages.map(image => {
                    const displayUrl = image.quax_url || image.url;
                    
                    if (!displayUrl) return '';

                    const uploadedDate = new Date(image.uploaded_at);
                    const formattedDate = uploadedDate.toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" });
                    
                    // Link ke halaman preview, menggunakan short_code
                    return `
                        <div class="gallery-item" data-shortcode="${image.short_code}">
                            <a href="/preview/${image.short_code}" class="item-link">
                                <div class="item-image-wrapper">
                                    <img src="${displayUrl}" alt="${image.original_name}" loading="lazy" class="item-image">
                                </div>
                                <div class="item-info">
                                    <div class="item-name">${image.original_name}</div>
                                    <div class="item-date">Diunggah: ${formattedDate}</div>
                                </div>
                            </a>
                        </div>
                    `;
                }).join('');

            } catch(e) {
                console.error("Error loading gallery:", e);
                galleryGrid.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>Gagal memuat galeri. ${e.message}</p></div>`;
            }
        }

        // =======================================================
        // EVENT LISTENERS
        // =======================================================

        // Menangani input file via tombol atau drag-and-drop
        document.getElementById("file-input").addEventListener("change", (e) => {
            handleFileSelection(e.target.files[0]);
        });
        document.getElementById("file-input-legacy").addEventListener("change", (e) => {
            handleFileSelection(e.target.files[0]);
        });
        
        // Menangani Drag and Drop (jika Anda memiliki elemen untuk itu)
        document.getElementById("file-upload-box").addEventListener("dragover", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--primary)";
        });

        document.getElementById("file-upload-box").addEventListener("dragleave", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--gray)";
        });

        document.getElementById("file-upload-box").addEventListener("drop", (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = "var(--gray)";
            handleFileSelection(e.dataTransfer.files[0]);
        });

        uploadBtn.addEventListener("click", uploadFile);

        // Inisialisasi
        document.addEventListener("DOMContentLoaded", () => {
            loadGallery();
        });

    </script>
</body>
</html>
